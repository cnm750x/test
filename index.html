<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æœƒå“¡å°ˆå€ - ä»£å¹£é–€æª»è§£é–</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0f0f1a;
      color: #e0e0ff;
      margin: 0;
      padding: 40px 20px;
      text-align: center;
    }
    h1 { color: #a78bfa; }
    button {
      background: #7c3aed;
      color: white;
      border: none;
      padding: 14px 32px;
      font-size: 1.1rem;
      border-radius: 12px;
      margin: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover { background: #9f7aea; transform: translateY(-2px); }
    button:disabled { background: #4b5563; cursor: not-allowed; }
    #status {
      margin: 30px auto;
      padding: 20px;
      max-width: 600px;
      border-radius: 12px;
      background: #1e1e38;
      min-height: 120px;
      line-height: 1.6;
    }
    .content {
      display: none;
      margin-top: 40px;
      padding: 30px;
      background: #1a1a2e;
      border-radius: 16px;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
      border: 1px solid #4b5563;
    }
    .paywall {
      color: #f87171;
      font-size: 1.3rem;
      font-weight: bold;
    }
    .success {
      color: #34d399;
      font-size: 1.4rem;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h1>æœƒå“¡å°ˆå€ï¼ˆä»£å¹£é–€æª»ç‰ˆï¼‰</h1>
<p>éœ€è¦æŒæœ‰ â‰¥ <b>100</b> å€‹ã€Œæˆ‘çš„æœƒå“¡å¡ã€ä»£å¹£æ‰èƒ½è§€çœ‹å…§å®¹</p>

<button id="connectBtn">é€£æ¥éŒ¢åŒ…ï¼ˆMetaMaskï¼‰</button>
<button id="checkBtn" disabled>æª¢æŸ¥ä»£å¹£æ•¸é‡</button>

<div id="status">
  è«‹å…ˆé»æ“Šã€Œé€£æ¥éŒ¢åŒ…ã€
</div>

<div id="gatedContent" class="content">
  <h2 class="success">âœ… é©—è­‰é€šéï¼æ­¡è¿é€²å…¥ä»˜è²»å…§å®¹å€</h2>
  <p>é€™æ˜¯åªæœ‰æŒæœ‰è¶³å¤ ä»£å¹£çš„äººæ‰çœ‹å¾—åˆ°çš„å…§å®¹ï½</p>
  <ul style="text-align:left; max-width:500px; margin:30px auto;">
    <li>é€™è£¡å¯ä»¥æ”¾ä½ çš„èª²ç¨‹å½±ç‰‡</li>
    <li>ç¨å®¶æ–‡ç« ã€PDFä¸‹è¼‰</li>
    <li>ç§äººDiscordé‚€è«‹é€£çµ</li>
    <li>æœªä¾†æ´»å‹•å„ªå…ˆå ±åè³‡æ ¼</li>
    <li>â‹¯â‹¯ä»»ä½•ä½ æƒ³æ”¶è²»çš„æ±è¥¿</li>
  </ul>
  <p style="margin-top:40px;">æ„Ÿè¬ä½ çš„æ”¯æŒï¼ğŸ’œ</p>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.15.0/ethers.umd.min.js"></script>
<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä½ è¦æ”¹çš„å››å€‹åœ°æ–¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TOKEN_ADDRESS = "0x2170ed0880ac9a755fd29b2688956bd959f933f8";   // â† æ”¹é€™è£¡
const MIN_AMOUNT   = 100;                                 // â† è‡³å°‘è¦æŒæœ‰çš„æ•¸é‡
const NETWORK      = "mainnet";                           // "mainnet" æˆ– "sepolia" æˆ–å…¶ä»–
// const NETWORK   = "sepolia";                           // æ¸¬è©¦ç¶²ç”¨é€™å€‹

// æ¨™æº– ERC-20 ABIï¼ˆåªéœ€è¦é€™ä¸‰å€‹å‡½æ•¸ï¼‰
const ERC20_ABI = [
  "function balanceOf(address owner) view returns (uint256)",
  "function decimals() view returns (uint8)",
  "function symbol() view returns (string)"
];
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const connectBtn = document.getElementById("connectBtn");
const checkBtn   = document.getElementById("checkBtn");
const statusDiv  = document.getElementById("status");
const contentDiv = document.getElementById("gatedContent");

let provider;
let signer;
let userAddress;
let tokenContract;

// 1. é€£æ¥éŒ¢åŒ…
connectBtn.onclick = async () => {
  if (!window.ethereum) {
    statusDiv.innerHTML = `<span style="color:#f87171">âŒ æ²’æœ‰åµæ¸¬åˆ° MetaMask æˆ–å…¶ä»–éŒ¢åŒ…</span>`;
    return;
  }

  try {
    statusDiv.innerHTML = "æ­£åœ¨è«‹æ±‚é€£æ¥éŒ¢åŒ…...";
    const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
    userAddress = accounts[0];

    // ä½¿ç”¨ ethers BrowserProvider (ethers v6)
    provider = new ethers.BrowserProvider(window.ethereum);
    signer   = await provider.getSigner();

    // é¡¯ç¤ºåœ°å€
    const shortAddr = userAddress.slice(0,6) + "..." + userAddress.slice(-4);
    statusDiv.innerHTML = `å·²é€£æ¥ï¼š${shortAddr}<br>æ­£åœ¨è¼‰å…¥ä»£å¹£è³‡è¨Š...`;

    // åˆå§‹åŒ–ä»£å¹£åˆç´„
    tokenContract = new ethers.Contract(TOKEN_ADDRESS, ERC20_ABI, provider);

    // å•Ÿç”¨æª¢æŸ¥æŒ‰éˆ•
    checkBtn.disabled = false;
    connectBtn.disabled = true;
    connectBtn.textContent = "å·²é€£æ¥ âœ“";

    // é †ä¾¿é¡¯ç¤ºä»£å¹£ç¬¦è™Ÿï¼ˆå¯é¸ï¼‰
    try {
      const symbol = await tokenContract.symbol();
      statusDiv.innerHTML += `<br>ä»£å¹£ï¼š${symbol}`;
    } catch(e) {}
  } catch (err) {
    statusDiv.innerHTML = `<span style="color:#f87171">é€£æ¥å¤±æ•—ï¼š${err.message || err}</span>`;
  }
};

// 2. æª¢æŸ¥é¤˜é¡
checkBtn.onclick = async () => {
  if (!tokenContract) {
    statusDiv.innerHTML = "è«‹å…ˆé€£æ¥éŒ¢åŒ…";
    return;
  }

  statusDiv.innerHTML = "æ­£åœ¨æŸ¥è©¢ä»£å¹£é¤˜é¡...";

  try {
    const rawBalance = await tokenContract.balanceOf(userAddress);
    const decimals   = await tokenContract.decimals();

    // è½‰æˆäººé¡å¯è®€æ•¸å­—
    const balance = Number(ethers.formatUnits(rawBalance, decimals));

    statusDiv.innerHTML = `ä½ çš„é¤˜é¡ï¼š${balance.toFixed(4)} å€‹<br>`;

    if (balance >= MIN_AMOUNT) {
      statusDiv.innerHTML += `<span class="success">âœ… é€šéé©—è­‰ï¼</span>`;
      contentDiv.style.display = "block";
    } else {
      statusDiv.innerHTML += `<span class="paywall">
        é¤˜é¡ä¸è¶³ï¼ˆéœ€è¦ ${MIN_AMOUNT} å€‹ï¼Œç›®å‰åªæœ‰ ${balance.toFixed(2)} å€‹ï¼‰<br>
        è«‹å…ˆå» Uniswap / äº¤æ˜“æ‰€ / åˆç´„è³¼è²·
      </span>`;
      contentDiv.style.display = "none";
    }
  } catch (err) {
    statusDiv.innerHTML = `<span style="color:#f87171">æŸ¥è©¢å¤±æ•—ï¼š${err.reason || err.message || err}</span>`;
    console.error(err);
  }
};

// å¦‚æœä½¿ç”¨è€…æ›å¸³è™Ÿæˆ–æ›ç¶²è·¯ï¼Œé‡æ–°æ•´ç†é é¢æ¯”è¼ƒä¿éšª
window.ethereum?.on("accountsChanged", () => location.reload());
window.ethereum?.on("chainChanged", () => location.reload());

</script>
</body>

</html>
